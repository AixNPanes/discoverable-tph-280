// const mdiTemperatureHigh = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>thermometer-high</title><path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5H11A1 1 0 0 1 12 4Z" /></svg>';
// const mdiTemperatureLow = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>thermometer-low</title><path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5V12H11V5A1 1 0 0 1 12 4Z" /></svg>';
// const mdiTemperature = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>thermometer</title><path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5V8H11V5A1 1 0 0 1 12 4Z" /></svg>';
// const mdiGauge = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>gauge</title><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12C20,14.4 19,16.5 17.3,18C15.9,16.7 14,16 12,16C10,16 8.2,16.7 6.7,18C5,16.5 4,14.4 4,12A8,8 0 0,1 12,4M14,5.89C13.62,5.9 13.26,6.15 13.1,6.54L11.81,9.77L11.71,10C11,10.13 10.41,10.6 10.14,11.26C9.73,12.29 10.23,13.45 11.26,13.86C12.29,14.27 13.45,13.77 13.86,12.74C14.12,12.08 14,11.32 13.57,10.76L13.67,10.5L14.96,7.29L14.97,7.26C15.17,6.75 14.92,6.17 14.41,5.96C14.28,5.91 14.15,5.89 14,5.89M10,6A1,1 0 0,0 9,7A1,1 0 0,0 10,8A1,1 0 0,0 11,7A1,1 0 0,0 10,6M7,9A1,1 0 0,0 6,10A1,1 0 0,0 7,11A1,1 0 0,0 8,10A1,1 0 0,0 7,9M17,9A1,1 0 0,0 16,10A1,1 0 0,0 17,11A1,1 0 0,0 18,10A1,1 0 0,0 17,9Z" /></svg>';
// const mdiWaterPercent = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>water-percent</title><path d="M12,3.25C12,3.25 6,10 6,14C6,17.32 8.69,20 12,20A6,6 0 0,0 18,14C18,10 12,3.25 12,3.25M14.47,9.97L15.53,11.03L9.53,17.03L8.47,15.97M9.75,10A1.25,1.25 0 0,1 11,11.25A1.25,1.25 0 0,1 9.75,12.5A1.25,1.25 0 0,1 8.5,11.25A1.25,1.25 0 0,1 9.75,10M14.25,14.5A1.25,1.25 0 0,1 15.5,15.75A1.25,1.25 0 0,1 14.25,17A1.25,1.25 0 0,1 13,15.75A1.25,1.25 0 0,1 14.25,14.5Z" /></svg>';
const mdiTemperatureHigh = '<path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5H11A1 1 0 0 1 12 4Z" />';
const mdiTemperatureLow = '<path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5V12H11V5A1 1 0 0 1 12 4Z" />';
const mdiTemperature = '<path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5V8H11V5A1 1 0 0 1 12 4Z" />';
const mdiGauge = '<path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12C20,14.4 19,16.5 17.3,18C15.9,16.7 14,16 12,16C10,16 8.2,16.7 6.7,18C5,16.5 4,14.4 4,12A8,8 0 0,1 12,4M14,5.89C13.62,5.9 13.26,6.15 13.1,6.54L11.81,9.77L11.71,10C11,10.13 10.41,10.6 10.14,11.26C9.73,12.29 10.23,13.45 11.26,13.86C12.29,14.27 13.45,13.77 13.86,12.74C14.12,12.08 14,11.32 13.57,10.76L13.67,10.5L14.96,7.29L14.97,7.26C15.17,6.75 14.92,6.17 14.41,5.96C14.28,5.91 14.15,5.89 14,5.89M10,6A1,1 0 0,0 9,7A1,1 0 0,0 10,8A1,1 0 0,0 11,7A1,1 0 0,0 10,6M7,9A1,1 0 0,0 6,10A1,1 0 0,0 7,11A1,1 0 0,0 8,10A1,1 0 0,0 7,9M17,9A1,1 0 0,0 16,10A1,1 0 0,0 17,11A1,1 0 0,0 18,10A1,1 0 0,0 17,9Z" />';
const mdiWaterPercent = '<path d="M12,3.25C12,3.25 6,10 6,14C6,17.32 8.69,20 12,20A6,6 0 0,0 18,14C18,10 12,3.25 12,3.25M14.47,9.97L15.53,11.03L9.53,17.03L8.47,15.97M9.75,10A1.25,1.25 0 0,1 11,11.25A1.25,1.25 0 0,1 9.75,12.5A1.25,1.25 0 0,1 8.5,11.25A1.25,1.25 0 0,1 9.75,10M14.25,14.5A1.25,1.25 0 0,1 15.5,15.75A1.25,1.25 0 0,1 14.25,17A1.25,1.25 0 0,1 13,15.75A1.25,1.25 0 0,1 14.25,14.5Z" />';
const viewBox = '0 0 24 24';

function transformTemperature(value, units) {
  switch(units.toUpperCase()) {
    case "°F":
      return Math.round((parseFloat(value) * 9.0 / 5.0) + 32.0, 1).toFixed(1);
      break;
    case "°K":
      return Math.round(parseFloat(value) + 273.15, 1).toFixed(1);
      break;
    case "°C":
      return Math.round(parseFloat(value), 1).toFixed(1);
      break;
    default:
      throw new Error(units + " must be one of °C, °F, or °K" + " not " + units);
   }
}

function transformPressure(value, units) {
  switch(units.toUpperCase()) {
    case "HPA":
      return Math.round(parseFloat(value), 1).toFixed(1);
      break;
    case "KPA":
      return Math.round(parseFloat(value) * 0.1, 1).toFixed(1);
      break;
    case "PA":
      return Math.round(parseFloat(value) * 100.0, 1).toFixed(1);
      break;
      case "BAR":
        return Math.round(parseFloat(value) * 0.001, 1).toFixed(1);
        break;
      case "CBAR":
        return Math.round(parseFloat(value) * 0.0001, 1).toFixed(1);
        break;
      case "MBAR":
        return Math.round(parseFloat(value), 1).toFixed(1);
        break;
      case "INHG":
        return Math.round(parseFloat(value) * 0.0296133971, 1).toFixed(1);
        break;
      case "MMHG":
        return Math.round(parseFloat(value) * 0.7500637554, 1).toFixed(1);
        break;
      case "PSI":
        return Math.round(parseFloat(value) * 0.0145037738, 1).toFixed(1);
        break;
      default:
        throw new Error(units + " must be one of °C, °F, or °K");
   }
}

function transformHumidity(value, units) {
  return value;
}

const colorTable = {
  'temperature': {
    '°C': [18.33, 23.89],
    '°F': [65.0, 75.0],
    '°K': [291.48, 297.04]
  },
  'pressure': {
    "HPA": [950.0, 1050.0],
    "KPA": [95.0, 105.0],
    "PA": [95000.0, 105000.0],
    "BAR": [.95, 1.05],
    "CBAR": [95.0, 105.0],
    "MBAR": [950.0, 1050.00],
    "INHG": [28.053, 31.0],
    "MMHG": [712.55, 787.56],
    "PSI": [13.77, 15.22]  
  },
  'humidity': {
    "%": [30.0, 50.0]
  }
}

function getColor(type, value, units) {
  var val = parseFloat(value);
  var range = colorTable[type][units.toUpperCase()];
  return val < range[0] ? 'lightskyblue' : val > range[1] ? 'red' : 'springgreen';
}

function getTemperatureColor(value, units) {
  return getColor('temperature', value, units);
}

function getPressureColor(value, units) {
  return getColor('pressure', value, units);
}

function getHumidityColor(value, units) {
  return getColor('humidity', value, units);
}

class UnitGauge extends HTMLElement {
  // Whenever the state changes, a new `hass` object is set. Use this to
  // update your content.
  set hass(hass) {
    // Initialize the content if it's not there yet.
    if (!this.unitGauge) {
      const root = document.querySelector(':root');
      root.style.setProperty('--unit-guage-card-width', '400px');
      root.style.setProperty('--type-custom-unit-guage-header-font-size', '24px');
      root.style.setProperty('--type-custom-unit-guage-header-text-align', 'center');
      root.style.setProperty('--type-custom-unit-guage-header-margin-block-start', '4px');
      root.style.setProperty('--type-custom-unit-guage-header-margin-block-end', '4px');
      root.style.setProperty('--unit-guage-div-display', 'flex');
      root.style.setProperty('--unit-guage-div-justify-content', 'center');
      root.style.setProperty('--unit-gauge-temperature-span-display', 'flex');
      root.style.setProperty('--unit-gauge-temperature-span-align-items', 'center');
      root.style.setProperty('--unit-gauge-temperature-span-justify-content', 'center');
      root.style.setProperty('--unit-gauge-pressure-span-display', 'flex');
      root.style.setProperty('--unit-gauge-pressure-span-align-items', 'center');
      root.style.setProperty('--unit-gauge-pressure-span-justify-content', 'center');
      root.style.setProperty('--unit-gauge-humidity-span-display', 'flex');
      root.style.setProperty('--unit-gauge-humidity-span-align-items', 'center');
      root.style.setProperty('--unit-gauge-humidity-span-justify-content', 'center');
      root.style.setProperty('--unit-gauge-temperature-content-display', 'flex');
      root.style.setProperty('--unit-gauge-temperature-content-justify-content', 'center');
      root.style.setProperty('--unit-gauge-pressure-content-display', 'flex');
      root.style.setProperty('--unit-gauge-pressure-content-justify-content', 'center');
      root.style.setProperty('--unit-gauge-humidity-content-display', 'flex');
      root.style.setProperty('--unit-gauge-humidity-content-justify-content', 'center');
      root.style.setProperty('--unit-gauge-temperature-icon-display', 'flex');
      root.style.setProperty('--unit-gauge-temperature-icon-align-items', 'center');
      root.style.setProperty('--unit-gauge-pressure-icon-display', 'flex');
      root.style.setProperty('--unit-gauge-pressure-icon-align-items', 'center');
      root.style.setProperty('--unit-gauge-humidity-icon-display', 'flex');
      root.style.setProperty('--unit-gauge-humidity-icon-align-items', 'center');
      root.style.setProperty('--unit-gauge-temperature-text-font-size', '18px');
      root.style.setProperty('--unit-gauge-temperature-text-text-align', 'center');
      root.style.setProperty('--unit-gauge-temperature-text-margin-block-start', '4px');
      root.style.setProperty('--unit-gauge-temperature-text-margin-block-end', '4px');
      root.style.setProperty('--unit-gauge-pressure-text-font-size', '18px');
      root.style.setProperty('--unit-gauge-pressure-text-text-align', 'center');
      root.style.setProperty('--unit-gauge-presure-text-margin-block-start', '4px');
      root.style.setProperty('--unit-gauge-pressure-text-margin-block-end', '4px');
      root.style.setProperty('--unit-gauge-humidity-text-font-size', '18px');
      root.style.setProperty('--unit-gauge-humidity-text-text-align', 'center');
      root.style.setProperty('--unit-gauge-humidity-text-margin-block-start', '4px');
      root.style.setProperty('--unit-gauge-humidity-text-margin-block-end', '4px');
      this.api_token = this.config.api_token;
        this.innerHTML = `
        <style>
          .unit-gauge-card {
            width: var(--unit-guage-card-width);
          }
          .type-custom-unit-gauge-header {
            font-size: var(--type-custom-unit-guage-header-font-size);
            text-align: var(--type-custom-unit-guage-header-text-align);
            margin-block-start: var(--type-custom-unit-guage-header-margin-block-start);
            margin-block-end: var(--type-custom-unit-guage-header-margin-block-end);
          }
          .unit-gauge-div {
            display: var(--unit-guage-div-display);
            justify-content: var(--unit-guage-div-justify-content);
          }
          .unit-gauge-temperature-span {
            display: var(--unit-gauge-temperature-span-display);
            align-items: var(--unit-gauge-temperature-span-align-items);
            justify-content: var(--unit-gauge-temperature-span-justify-content);
          }
          .unit-gauge-pressure-span {
            display: var(--unit-gauge-pressure-span-display);
            align-items: var(--unit-gauge-pressure-span-align-items);
            justify-content: var(--unit-gauge-pressure-span-justify-content);
          }
          .unit-gauge-humidity-span {
            display: var(--unit-gauge-humidity-span-display);
            align-items: var(--unit-gauge-humidity-span-align-items);
            justify-content: var(--unit-gauge-humidity-span-justify-content);
          }
          .unit-gauge-temperature-content {
            display: var(--unit-gauge-temperature-content-display);
            justify-content: var(--unit-gauge-temperature-content-justify-content);
          }
          .unit-gauge-pressure-content {
            display: var(--unit-gauge-pressure-content-display);
            justify-content: var(--unit-gauge-pressure-content-justify-content);
          }
          .unit-gauge-humidity-content {
            display: var(--unit-gauge-humidity-content-display);
            justify-content: var(--unit-gauge-humidity-content-justify-content);
          }
          .unit-gauge-temperature-icon {
            display: var(--unit-gauge-temperature-icon-display);
            align-items: var(--unit-gauge-temperature-icon-align-items);
          }
          .unit-gauge-pressure-icon {
            display: var(--unit-gauge-pressure-icon-display);
            align-items: var(--unit-gauge-pressure-icon-align-items);
          }
          .unit-gauge-humidity-icon {
            display: var(--unit-gauge-humidity-icon-display);
            align-items: var(--unit-gauge-humidity-icon-align-items);
          }
          .unit-gauge-temperature-text {
            font-size: var(--unit-gauge-temperature-text-font-size);
            text-align: var(--unit-gauge-temperature-text-text-align);
            margin-block-start: var(--unit-gauge-temperature-text-margin-block-start);
            margin-block-end: var(--unit-gauge-temperature-text-margin-block-end);
          }
          .unit-gauge-pressure-text {
            font-size: var(--unit-gauge-pressure-text-font-size);
            text-align: var(--unit-gauge-pressure-text-text-align);
            margin-block-start: var(--unit-gauge-pressure-text-margin-block-start);
            margin-block-end: var(--unit-gauge-pressure-text-margin-block-end);
          }
          .unit-gauge-humidity-text {
            font-size: var(--unit-gauge-humidity-text-font-size);
            text-align: var(--unit-gauge-humidity-text-text-align);
            margin-block-start: var(--unit-gauge-humidity-text-margin-block-start);
            margin-block-end: var(--unit-gauge-humidity-text-margin-block-end);
          }
          .temperature-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
          }
          .temperature-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
          }
          .temperature-dropdown-content a:hover {
            background-color: #f1f1f1;
          }
          .temperature-show {
            display: block;
          }
          .pressure-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
          }
          .pressure-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
          }
          .pressure-dropdown-content a:hover {
            background-color: #f1f1f1;
          }
          .pressure-show {
            display: block;
          }
          .humidity-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
          }
          .humidity-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
          }
          .humidity-dropdown-content a:hover {
            background-color: #f1f1f1;
          }          
          .humidity-show {
            display: block;
          }
          .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
          }
          .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
          }
          .dropdown-content a:hover {
            background-color: #f1f1f1;
          }
          .show {
            display: block;
          }
        </style>        
        <h1 class="type-custom-unit-gauge-header">Environment</h1>
        <div class="unit-gauge-div">
          <span class="unit-gauge-temperature-span">
            <div class="unit-gauge-temperature-content">
              <span class="unit-gauge-temperature-icon">
                <svg fill="green" height="36" width="36" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 13V5A3 3 0 0 0 9 5V13A5 5 0 1 0 15 13M12 4A1 1 0 0 1 13 5V8H11V5A1 1 0 0 1 12 4Z" />
                </svg>
              </span>
              <span class="unit-gauge-temperature-text" onclick="popup('<h1>popup</h1>')">
                <div class="unit-gauge-temperature-label">Temp.X</div>
                <div class="unit-gauge-temperature-text-div">
                  <span class="unit-gauge-temperature-text-span">
                    <span class="unit-gauge-temperature-text-value">21.7</span>
                    <span class="unit-gauge-temperature-text-units">°C</span>
                  </span>
                </div>
              </span>
            </div>
            <div id="temperatureDropdown" class="temperature-dropdown-content"></div
          </span>
          <span class="unit-gauge-pressure-span">
            <div class="unit-gauge-pressure-content">
              <span class="unit-gauge-pressure-icon">
                <svg fill="green" height="36" width="36" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12C20,14.4 19,16.5 17.3,18C15.9,16.7 14,16 12,16C10,16 8.2,16.7 6.7,18C5,16.5 4,14.4 4,12A8,8 0 0,1 12,4M14,5.89C13.62,5.9 13.26,6.15 13.1,6.54L11.81,9.77L11.71,10C11,10.13 10.41,10.6 10.14,11.26C9.73,12.29 10.23,13.45 11.26,13.86C12.29,14.27 13.45,13.77 13.86,12.74C14.12,12.08 14,11.32 13.57,10.76L13.67,10.5L14.96,7.29L14.97,7.26C15.17,6.75 14.92,6.17 14.41,5.96C14.28,5.91 14.15,5.89 14,5.89M10,6A1,1 0 0,0 9,7A1,1 0 0,0 10,8A1,1 0 0,0 11,7A1,1 0 0,0 10,6M7,9A1,1 0 0,0 6,10A1,1 0 0,0 7,11A1,1 0 0,0 8,10A1,1 0 0,0 7,9M17,9A1,1 0 0,0 16,10A1,1 0 0,0 17,11A1,1 0 0,0 18,10A1,1 0 0,0 17,9Z" />
                </svg>
              </span>
              <span class="unit-gauge-pressure-text">
                <div class="unit-gauge-pressure-label">Pres.</div>
                <div class="unit-gauge-pressure-text-div">
                  <span class="unit-gauge-pressure-text-span">
                    <span class="unit-gauge-pressure-text-value">1105</span>
                    <span class="unit-gauge-pressure-text-units">hPA</span>
                  </span>
                </div>
              </span>
            </div>
            <div id="pressureDropdown" class="pressure-dropdown-content">pressure</div
          </span>
          <span class="unit-gauge-humidity-span">
            <div class="unit-gauge-humidity-content">
              <span class="unit-gauge-humidity-icon">
                <svg fill="green" height="36" width="36" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12,3.25C12,3.25 6,10 6,14C6,17.32 8.69,20 12,20A6,6 0 0,0 18,14C18,10 12,3.25 12,3.25M14.47,9.97L15.53,11.03L9.53,17.03L8.47,15.97M9.75,10A1.25,1.25 0 0,1 11,11.25A1.25,1.25 0 0,1 9.75,12.5A1.25,1.25 0 0,1 8.5,11.25A1.25,1.25 0 0,1 9.75,10M14.25,14.5A1.25,1.25 0 0,1 15.5,15.75A1.25,1.25 0 0,1 14.25,17A1.25,1.25 0 0,1 13,15.75A1.25,1.25 0 0,1 14.25,14.5Z" />
                </svg>
              </span>
              <span class="unit-gauge-humidity-text">
                <div class="unit-gauge-humidity-label">Hum.</div>
                <div class="unit-gauge-humidity-text-div">
                  <span class="unit-gauge-humidity-text-span">
                    <span class="unit-gauge-humidity-text-value">49</span>
                    <span class="unit-gauge-humidity-text-units">%</span>
                  </span>
                </div>
              </span>
            </div>
            <div id="humidityDropdown" class="humidity-dropdown-content">humidity</div
          </span>
        </div>
      `;

      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.text = `
      function popup(htmlContent) {
        var popup = window.open("", "PopupWindow", "popup,width=500,height=500");
        popup.document.write(htmlContent);
        popup.document.close();
      }
      `;
      document.head.appendChild(script);

      this.unitGauge = this;
      this.unitGaugeH1 = this.querySelector("h1");
      this.unitGaugeHeader = this.querySelector(".type-custom-unit-gauge-header");
      this.unitGaugeDiv = this.querySelector(".unit-gauge-div");

      this.unitGaugeTemperatureSpan = this.unitGaugeDiv.querySelector(".unit-gauge-temperature-span");
      this.unitGaugeTemperatureContent = this.unitGaugeTemperatureSpan.querySelector(".unit-gauge-temperature-content");
      this.unitGaugeTemperatureIcon = this.unitGaugeTemperatureContent.querySelector(".unit-gauge-temperature-icon");
      this.unitGaugeTemperatureSvg = this.unitGaugeTemperatureIcon.querySelector("svg");
      this.unitGaugeTemperatureText = this.unitGaugeTemperatureContent.querySelector(".unit-gauge-temperature-text");
      this.unitGaugeTemperatureLabel = this.unitGaugeTemperatureText.querySelector(".unit-gauge-temperature-label");
      this.unitGaugeTemperatureTextDiv = this.unitGaugeTemperatureText.querySelector(".unit-gauge-temperature-text-div");
      this.unitGaugeTemperatureTextSpan = this.unitGaugeTemperatureTextDiv.querySelector(".unit-gauge-temperature-text-span");
      this.unitGaugeTemperatureTextValue = this.unitGaugeTemperatureTextSpan.querySelector(".unit-gauge-temperature-text-value");
      this.unitGaugeTemperatureTextUnits = this.unitGaugeTemperatureTextSpan.querySelector(".unit-gauge-temperature-text-units");
      this.unitGaugeTemperatureUnitsDropdown = this.unitGaugeTemperatureSpan.querySelector('.temperature-dropdown-content');

      this.unitGaugePressureSpan = this.unitGaugeDiv.querySelector(".unit-gauge-pressure-span");
      this.unitGaugePressureContent = this.unitGaugePressureSpan.querySelector(".unit-gauge-pressure-content");
      this.unitGaugePressureIcon = this.unitGaugePressureContent.querySelector(".unit-gauge-pressure-icon");
      this.unitGaugePressureSvg = this.unitGaugePressureIcon.querySelector("svg");
      this.unitGaugePressureText = this.unitGaugePressureContent.querySelector(".unit-gauge-pressure-text");
      this.unitGaugePressureLabel = this.unitGaugePressureText.querySelector(".unit-gauge-pressure-label");
      this.unitGaugePressureTextDiv = this.unitGaugePressureText.querySelector(".unit-gauge-pressure-text-div");
      this.unitGaugePressureTextSpan = this.unitGaugePressureTextDiv.querySelector(".unit-gauge-pressure-text-span");
      this.unitGaugePressureTextValue = this.unitGaugePressureTextSpan.querySelector(".unit-gauge-pressure-text-value");
      this.unitGaugePressureTextUnits = this.unitGaugePressureTextSpan.querySelector(".unit-gauge-pressure-text-units");
      this.unitGaugePressureUnitsDropdown = this.unitGaugePressureSpan.querySelector('pressureDropdown');

      this.unitGaugeHumiditySpan = this.unitGaugeDiv.querySelector(".unit-gauge-humidity-span");
      this.unitGaugeHumidityContent = this.unitGaugeHumiditySpan.querySelector(".unit-gauge-humidity-content");
      this.unitGaugeHumidityIcon = this.unitGaugeHumidityContent.querySelector(".unit-gauge-humidity-icon");
      this.unitGaugeHumiditySvg = this.unitGaugeHumidityIcon.querySelector("svg");
      this.unitGaugeHumidityText = this.unitGaugeHumidityContent.querySelector(".unit-gauge-humidity-text");
      this.unitGaugeHumidityLabel = this.unitGaugeHumidityText.querySelector(".unit-gauge-humidity-label");
      this.unitGaugeHumidityTextDiv = this.unitGaugeHumidityText.querySelector(".unit-gauge-humidity-text-div");
      this.unitGaugeHumidityTextSpan = this.unitGaugeHumidityTextDiv.querySelector(".unit-gauge-humidity-text-span");
      this.unitGaugeHumidityTextValue = this.unitGaugeHumidityTextSpan.querySelector(".unit-gauge-humidity-text-value");
      this.unitGaugeHumidityTextUnits = this.unitGaugeHumidityTextSpan.querySelector(".unit-gauge-humidity-text-units");
      this.unitGaugeHumidityUnitsDropdown = this.unitGaugeHumiditySpan.querySelector('humidityDropdown');
      
      this.setAttribute('class', 'unit-gauge-card');
      this.unitGaugeTemperatureText.addEventListener('click', () => {
        this.unitGaugeTemperatureUnitsDropdown.classList.toggle('temperature-dropdown-content');
      });

      this.labelId = this.config.label;
      this.temperatureLabelId = this.config.temperature_label;
      this.pressureLabelId = this.config.pressure_label;
      this.humidityLabelId = this.config.humidity_label;

      this.temperatureUnitsId = this.config.temperature_units;
      this.pressureUnitsId = this.config.pressure_units;
      this.humidityUnitsId = this.config.humidity_units;
  
      this.label = hass.states[this.labelId];
      this.temperatureLabel = hass.states[this.temperatureLabelId];
      this.pressureLabel = hass.states[this.pressureLabelId];
      this.humidityLabel = hass.states[this.humidityLabelId];

      this.temperatureUnits = hass.states[this.temperatureUnitsId];
      this.pressureUnits = hass.states[this.pressureUnitsId];
      this.humidityUnits = hass.states[this.humidityUnitsId];

      this.temperatureUnitsStr = this.temperatureUnits ? this.temperatureUnits.state : "unavailable";
      this.pressureUnitsStr = this.pressureUnits ? this.pressureUnits.state : "unavailable";
      this.humidityUnitsStr = this.humidityUnits ? this.humidityUnits.state : "unavailable";

      this.temperatureUnitsList =  this.temperatureUnits.attributes.options;
      this.pressureUnitsList =  this.pressureUnits.attributes.options;
      this.humidityUnitsList =  this.humidityUnits.attributes.options;
  
      this.labelStr = this.label ? this.label.state : "unavailable";  
      this.temperatureLabelStr = this.temperatureLabel ? this.temperatureLabel.state : "unavailable";
      this.pressureLabelStr = this.pressureLabel ? this.pressureLabel.state : "unavailable";
      this.humidityLabelStr = this.humidityLabel ? humidityLabel.state : "unavailable";

      this.temperatureEntityId = this.config.temperature_entity;
      this.pressureEntityId = this.config.pressure_entity;
      this.humidityEntityId = this.config.humidity_entity;
    }

    const temperatureState = hass.states[this.temperatureEntityId];
    const pressureState = hass.states[this.pressureEntityId];
    const humidityState = hass.states[this.humidityEntityId];

    const temperatureStateStr = temperatureState ? temperatureState.state : "unavailable";
    const pressureStateStr = pressureState ? pressureState.state : "unavailable";
    const humidityStateStr = humidityState ? humidityState.state : "unavailable";

//    const temperatureSelect = this.buildPopup("Temperature Units", temperatureUnitsList, temperatureUnitsStr);
//    const pressureSelect = this.buildPopup("Pressure Units", pressureUnitsList, pressureUnitsStr);
//    const humiditySelect = this.buildPopup("Humidity Units", humidityUnitsList, humidityUnitsStr);

    const temperatureColor = getTemperatureColor(temperatureStateStr, this.temperatureUnitsStr);
    const temperature = transformTemperature(temperatureStateStr, this.temperatureUnitsStr);

    const pressureColor = getPressureColor(pressureStateStr, this.pressureUnitsStr);
    const pressure = transformPressure(pressureStateStr, this.pressureUnitsStr);

    const humidityColor = getHumidityColor(humidityStateStr, this.humidityUnitsStr);
    const humidity = transformHumidity(humidityStateStr, this.humidityUnitsStr);

    this.unitGaugeHeader.innerHTML = `${this.labelId}`;

    this.unitGaugeTemperatureSvg.setAttribute('fill', getTemperatureColor(temperature, this.temperatureUnitsStr));
    this.unitGaugeTemperatureLabel.innerHTML = `${this.temperatureLabelId}`;
    this.unitGaugeTemperatureTextValue.innerHTML = `${temperature}`;
    this.unitGaugeTemperatureTextUnits.innerHTML = `${this.temperatureUnitsStr}`;

    this.unitGaugePressureSvg.setAttribute('fill', getPressureColor(pressure, this.pressureUnitsStr));
    this.unitGaugePressureLabel.innerHTML = `${this.pressureLabelId}`;
    this.unitGaugePressureTextValue.innerHTML = `${pressure}`;
    this.unitGaugePressureTextUnits.innerHTML = `${this.pressureUnitsStr}`;

    this.unitGaugeHumiditySvg.setAttribute('fill', getHumidityColor(humidity, this.humidityUnitsStr));
    this.unitGaugeHumidityLabel.innerHTML = `${this.humidityLabelId}`;
    this.unitGaugeHumidityTextValue.innerHTML = `${humidity}`;
    this.unitGaugeHumidityTextUnits.innerHTML = `${this.humidityUnitsStr}`;

    this.unitGaugeTemperatureText.onclick = () => {
      this.getPopup(
        'temperature',
        this.temperatureUnitsId,
        this.temperatureUnitsList,
        this.temperatureUnitsStr);
    }
    this.unitGaugePressureText.onclick = () => {
      this.getPopup(
        'pressure',
        this.pressureUnitsId,
        this.pressureUnitsList,
        this.pressureUnitsStr);
    }
    this.unitGaugeHumidityText.onclick = () => {
      this.getPopup(
        'humidity',
        this.humidityUnitsId,
        this.humidityUnitsList,
        this.humidityUnitsStr);
    }
  }

  getPopup(name, unitsId, unitsList, unitsStr) {
    var lower = name.toLowerCase();
    var upper = lower.charAt(0).toUpperCase() + lower.slice(1)
    var ws_url = window.location.origin.replace(/https?:/i, 'ws:') + '/api/websocket';
    var html_id = lower + 'UnitsSelect';
    var window_title = upper + ' Unit Selection';
    var htmlContent = `
    <html>
      <head>
        <title>${window_title}</title>
        <script>
          function setInputSelectState(id, state) {
            const message = {
              id: 27,
              type: "call_service",
              domain: "input_select",
              service: "select_option",
              service_data: {
                entity_id: id,
                option: state,
              },
            };
            const authMessage = {
              type: "auth",
              access_token: "${this.api_token}"
            };
            const socket = new WebSocket('${ws_url}');
            socket.addEventListener("message", (event) => {
              const msg = JSON.parse(event.data);
              if (msg['type'] === 'auth_required') {
                socket.send(JSON.stringify(authMessage));
              }
              else if (msg['type'] === 'auth_ok') {
                socket.send(JSON.stringify(message));
              }
              else if (msg['type'] === 'result') {
                socket.close();
              }
            });
            socket.addEventListener("close", () => {
              closePopup();
            });
            }      
          function getSelectedTemperatureUnits(entity_id) {
            var popup = window.open('', "PopupWindow");
            var select = popup.document.getElementById("${html_id}");
            setInputSelectState(entity_id, select.value);
          }
          function closePopup() {
            var popup = window.open('', "PopupWindow");
            popup.close();
          }
        </script>
        <style>
          :root {
            --card-background-color: #1c1c1c;
            --primary-text-color: #e1e1e1;
            --primary-background-color: var(--ha-card-background,var(--card-background-color,#ffffff));
            --mdc-dialog-content-ink-color: var(--primary-text-color);
          }
          body {
            background-color: var(--primary-background-color);
            color: var(--ha-card-header-color, var(--primary-text-color));
          }
          select {
            fill-color: var(--mdc-select-fill-color, #f5f5f5);
            background-color: var(--mdc-select-fill-color, rgb(255,255,255,.05));
            color: var(--mdc-dialog-content-ink-color,rgba(0,0,0,.6));
          }
          button {
            fill-color: var(--mdc-select-fill-color, #f5f5f5);
            background-color: var(--mdc-select-fill-color, rgb(255,255,255,.05));
            color: var(--mdc-dialog-content-ink-color,rgba(0,0,0,.6));
            border-radius: 6px;
          }
        </style>
      </head>
      <body>
        <h1>Select ${upper} Units</h1>
        <div>
          <select id="${html_id}">
          </select>
          <br><br>
          <button onclick="getSelectedTemperatureUnits('${unitsId}')">Select</button>
          <button onclick="closePopup()">Cancel</button>
          <br><br>
          You may need to reload the page to reflect changes.
        </div>
      </body>
    </html>
    `;

    var popup = window.open('', "PopupWindow", "width=400, height=200");
    popup.document.write(htmlContent);
    popup.document.close();
    var select = popup.document.querySelector("#" + html_id);
    select.innerHTML= unitsList.
      map((el) => `          <option value="${el}"${el === unitsStr?' selected':''}>${el}</option>
    `).join('');
}

  // The user supplied configuration. Throw an exception and Home Assistant
  // will render an error card.
  setConfig(config) {
    if (!config.label) {
      throw new Error("You need to define a main label");
    }
    if (!config.temperature_label) {
      throw new Error("You need to define a temperature label");
    }
    if (!config.temperature_entity) {
      throw new Error("You need to define a temperature entity");
    }
    if (!config.temperature_units) {
      throw new Error("You need to define an input_select for temperature units");
    }
    if (!config.pressure_label) {
      throw new Error("You need to define a pressure label");
    }
    if (!config.pressure_entity) {
      throw new Error("You need to define a pressure entity");
    }
    if (!config.pressure_units) {
      throw new Error("You need to define an input_select for pressure units");
    }
    if (!config.humidity_label) {
      throw new Error("You need to define a humidity label");
    }
    if (!config.humidity_entity) {
      throw new Error("You need to define a humidity entity");
    }
    if (!config.humidity_units) {
      throw new Error("You need to define an input_select for humidity units");
    }
    if (!config.api_token) {
      throw new Error("You need to define an api_token");
    }
    this.config = config;
  }

  // The height of your card. Home Assistant uses this to automatically
  // distribute all cards over the available columns.
  getCardSize() {
    return 1;
  }
}

customElements.define("unit-gauge", UnitGauge);
